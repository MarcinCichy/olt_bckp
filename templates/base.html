<!doctype html>
<html lang="pl" data-theme="light">
<head>
    <meta charset="utf-8">
    <title>{% block title %}OLT Backup{% endblock %}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <script>
        (function () {
            var saved = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
            document.documentElement.setAttribute('data-bs-theme', saved);
        })();
    </script>

    {% block extra_head %}{% endblock %}
</head>
<body>
<header class="fixed-top">
    <div class="container py-2">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
                <h1 class="h4 mb-1">OLT Backup ‚Äì panel Web</h1>
                <nav class="small">
                    <a href="{{ url_for('index') }}" class="me-2">Strona g≈Ç√≥wna</a>
                    <span class="text-muted">|</span>
                    <a href="{{ url_for('show_latest_backups') }}" class="mx-2">Ostatnie backupy</a>

                    {% if current_user.is_authenticated and current_user.is_admin %}
                    <span class="text-muted">|</span>
                    <a href="{{ url_for('user_admin.list_users') }}" class="mx-2 text-warning">U≈ºytkownicy</a>
                    {% endif %}

                    {% if current_user.is_authenticated %}
                    <span class="text-muted ms-3 me-1">|</span>
                    <a href="{{ url_for('auth.logout') }}" class="text-danger">Wyloguj</a>
                    {% endif %}
                </nav>
            </div>
            <button id="theme-toggle" class="btn btn-outline-secondary btn-sm" type="button" title="Prze≈ÇƒÖcz motyw">
                <span id="theme-icon">üåô</span>
            </button>
        </div>
    </div>
</header>

<main class="container my-3 main-content">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="mb-3">
          {% for message in messages %}
            <div class="alert alert-info mb-2" role="alert">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
</main>

<footer class="footer-bar fixed-bottom">
    <div class="container py-1 text-center">
        ¬© 2025 Created by Marcin Cichy
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        // --- 1. Obs≈Çuga prze≈ÇƒÖczania motywu (Dark/Light) ---
        var btn = document.getElementById('theme-toggle');
        var icon = document.getElementById('theme-icon');

        if (btn && icon) {
            function updateIcon() {
                var theme = document.documentElement.getAttribute('data-bs-theme') || 'dark';
                if (theme === 'light') {
                    icon.textContent = 'üåô';
                    btn.title = 'Prze≈ÇƒÖcz na tryb ciemny';
                } else {
                    icon.textContent = '‚òÄÔ∏è';
                    btn.title = 'Prze≈ÇƒÖcz na tryb jasny';
                }
            }
            updateIcon();

            btn.addEventListener('click', function () {
                var current = document.documentElement.getAttribute('data-theme') || 'dark';
                var next = (current === 'light') ? 'dark' : 'light';

                document.documentElement.setAttribute('data-theme', next);
                document.documentElement.setAttribute('data-bs-theme', next);

                localStorage.setItem('theme', next);
                updateIcon();
            });
        }

        // --- 2. ZAAWANSOWANE BEZPIECZE≈ÉSTWO: Wylogowanie po zamkniƒôciu karty ---

        // Pobieramy status zalogowania z backendu (Jinja renderuje to jako tekst "True" lub "False")
        var isBackendAuthenticated = "{{ current_user.is_authenticated }}" === "True";

        if (isBackendAuthenticated) {
            // Sprawdzamy, czy w tej sesji przeglƒÖdarki (karcie) mamy ustawionƒÖ flagƒô
            var sessionFlag = sessionStorage.getItem("olt_session_active");

            if (!sessionFlag) {
                // Je≈õli backend m√≥wi "Zalogowany", ale flaga w sessionStorage nie istnieje,
                // to znaczy, ≈ºe u≈ºytkownik zamknƒÖ≈Ç wcze≈õniej kartƒô/przeglƒÖdarkƒô.
                // Wymuszamy wylogowanie (kill cookie).
                window.location.href = "{{ url_for('auth.logout') }}";
            }
        }

        // Ustawiamy flagƒô, ≈ºe ta karta jest aktywna.
        // sessionStorage jest kasowane po zamkniƒôciu karty, ale zostaje po od≈õwie≈ºeniu (F5).
        sessionStorage.setItem("olt_session_active", "1");
    });
</script>

{% block extra_scripts %}{% endblock %}
</body>
</html>