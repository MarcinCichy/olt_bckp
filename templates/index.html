{% extends "base.html" %}
{% block title %}OLT Backup ‚Äì urzƒÖdzenia{% endblock %}

{% block extra_head %}
    {% if has_running %}
        <meta http-equiv="refresh" content="5">
    {% endif %}
{% endblock %}

{% block content %}
<h2 class="h5 mb-3">Lista urzƒÖdze≈Ñ</h2>

<div class="button-bar d-flex justify-content-between align-items-start">

    <div class="d-flex gap-2 flex-wrap">
        <form method="post" action="{{ url_for('backup_all') }}" class="inline">
            <button type="submit" class="btn btn-primary btn-sm">Backup wszystkich</button>
        </form>

        <button type="submit" class="btn btn-primary btn-sm" form="backup-selected-form">
            Backup wybranych
        </button>

        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('show_latest_backups') }}">Ostatnie backupy</a>

        {% if has_running %}
        <form method="post" action="{{ url_for('backup_cancel') }}" class="inline">
            <button type="submit" class="btn btn-warning btn-sm">
                Zatrzymaj aktualny backup
            </button>
        </form>
        {% endif %}
    </div>

    <div>
        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
            + Dodaj urzƒÖdzenie
        </button>
    </div>
</div>

{% if devices %}
<form method="post" action="{{ url_for('backup_selected') }}" id="backup-selected-form">
    <div class="mb-2">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="select-all">
            <label class="form-check-label" for="select-all">Zaznacz wszystkie</label>
        </div>
    </div>

    <table id="device-table" class="table table-sm table-striped table-hover align-middle">
        <thead>
        <tr>
            <th style="width: 40px;">#</th>
            <th>Adres IP / sysname</th>
            <th style="width: 160px;">Ostatni backup</th>
            <th style="width: 80px;">Status</th>
            <th style="width: 180px;">Akcje</th>
        </tr>
        </thead>
        <tbody>
        {% for d in devices %}
        <tr>
            <td>
                <input type="checkbox" class="form-check-input" name="device_ip" value="{{ d.ip }}">
            </td>
            <td>
                <span class="fw-semibold">{{ d.ip }}</span>
                {% if d.sysname %}
                    <span class="text-muted small">({{ d.sysname }})</span>
                {% endif %}
            </td>
            <td>
                {% if d.last_backup_time %}
                    {{ d.last_backup_time.strftime("%Y-%m-%d %H:%M") }}
                {% else %}
                    <span class="text-muted">‚Äì</span>
                {% endif %}
            </td>
            <td class="status-cell">
                {% if d.last_status == 'running' %}
                    <span class="status-running" title="W toku">‚è≥</span>
                {% elif d.last_status == 'success' %}
                    <span class="status-ok" title="Sukces">‚úÖ</span>
                {% else %}
                    <span class="status-fail" title="B≈ÇƒÖd: {{ d.last_error }}">‚ùå</span>
                {% endif %}
            </td>
            <td>
                <div class="d-flex gap-1">
                    <a class="btn btn-sm btn-secondary flex-grow-1"
                       href="{{ url_for('device_details', dev_id=d.id) }}">
                       Szczeg√≥≈Çy
                    </a>

                    <button type="button" class="btn btn-sm btn-outline-danger"
                            onclick="if(confirm('Czy na pewno usunƒÖƒá urzƒÖdzenie {{ d.ip }} z listy? Historia backup√≥w pozostanie.')) { document.getElementById('del-dev-{{ d.id }}').submit(); }">
                        üóëÔ∏è
                    </button>
                </div>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</form>

{% for d in devices %}
<form id="del-dev-{{ d.id }}" action="{{ url_for('delete_device', dev_id=d.id) }}" method="POST" style="display:none;"></form>
{% endfor %}

{% else %}
<p class="mt-3">Brak urzƒÖdze≈Ñ w bazie. Kliknij "Dodaj urzƒÖdzenie" lub u≈ºyj importu.</p>
{% endif %}

<div class="modal fade" id="addDeviceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: var(--card-bg); color: var(--text-color);">
            <div class="modal-header">
                <h5 class="modal-title">Dodaj nowe urzƒÖdzenie</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('add_device') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="ipInput" class="form-label">Adres IP</label>
                        <input type="text" class="form-control" id="ipInput" name="ip" placeholder="np. 192.168.1.10" required>
                        <div class="form-text">UrzƒÖdzenie zostanie dodane do bazy i uwzglƒôdnione w backupach.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="submit" class="btn btn-success">Zapisz</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="card mt-4 border-secondary">
    <div class="card-body">
        <h2 class="h5 card-title">Automatyczny backup (CRON / harmonogram)</h2>
        <form method="post" action="{{ url_for('update_schedule') }}">
            <div class="mb-2">
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="schedule-enabled" name="enabled"
                           {% if schedule.enabled %}checked{% endif %}>
                    <label class="form-check-label" for="schedule-enabled">
                        W≈ÇƒÖcz automatyczny backup raz dziennie
                    </label>
                </div>
            </div>
            <div class="mb-2">
                <label class="form-label form-label-sm">Godzina uruchomienia:</label>
                <div class="d-flex align-items-center gap-1">
                    <input type="number" name="hour" min="0" max="23" value="{{ schedule.hour }}"
                           class="form-control form-control-sm" style="max-width: 70px;">
                    <span>:</span>
                    <input type="number" name="minute" min="0" max="59" value="{{ schedule.minute }}"
                           class="form-control form-control-sm" style="max-width: 70px;">
                </div>
            </div>
            <button type="submit" class="btn btn-primary btn-sm mt-1">Zapisz harmonogram</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var selectAll = document.getElementById('select-all');
        var rows = Array.from(document.querySelectorAll('#device-table tbody tr'));

        if (selectAll) {
            selectAll.addEventListener('change', function () {
                var checked = selectAll.checked;
                rows.forEach(function (row) {
                    var cb = row.querySelector('input[type="checkbox"][name="device_ip"]');
                    if (cb) cb.checked = checked;
                });
            });
        }
    });
</script>
{% endblock %}