{% extends "base.html" %}
{% block title %}OLT Backup – urządzenia{% endblock %}

{% block extra_head %}
    {% if has_running %}
        <meta http-equiv="refresh" content="5">
    {% endif %}
{% endblock %}

{% block content %}
<h2 class="h5 mb-3">Lista urządzeń</h2>

{% if devices %}

<div class="button-bar">
    <form method="post" action="{{ url_for('backup_all') }}" class="inline">
        <button type="submit" class="btn btn-primary btn-sm">Backup wszystkich urządzeń</button>
    </form>

    <button type="submit" class="btn btn-primary btn-sm" form="backup-selected-form">
        Backup wybranych (zaznacz poniżej)
    </button>

    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('show_latest_backups') }}">Ostatnie backupy</a>

    {% if has_running %}
    <form method="post" action="{{ url_for('backup_cancel') }}" class="inline">
        <button type="submit" class="btn btn-warning btn-sm">
            Zatrzymaj aktualny backup
        </button>
    </form>
    {% endif %}
</div>

<form method="post" action="{{ url_for('backup_selected') }}" id="backup-selected-form">

    <div class="mb-2">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="select-all">
            <label class="form-check-label" for="select-all">
                Zaznacz wszystkie
            </label>
        </div>
    </div>

    <table id="device-table" class="table table-sm table-striped table-hover align-middle">
        <thead>
        <tr>
            <th style="width: 40px;">Wybierz</th>
            <th>Adres IP / sysname</th>
            <th style="width: 160px;">Ostatni backup</th>
            <th style="width: 80px;">Status</th>
            <th style="width: 130px;">Backupy</th>
            <th style="width: 90px;">Logi</th>
        </tr>
        </thead>
        <tbody>
        {% for d in devices %}
        <tr>
            <td>
                <input type="checkbox" class="form-check-input" name="device_ip" value="{{ d.ip }}">
            </td>
            <td>
                <span class="fw-semibold">{{ d.ip }}</span>
                {% if d.sysname %}
                    <span class="text-muted">({{ d.sysname }})</span>
                {% endif %}
            </td>
            <td>
                {% if d.last_backup %}
                    {{ d.last_backup.strftime("%Y-%m-%d %H:%M") }}
                {% else %}
                    <span class="text-muted">–</span>
                {% endif %}
            </td>
            <td class="status-cell">
                {% if d.status == 'running' %}
                    <span class="status-running" title="Backup w toku">⏳</span>
                {% elif d.status == 'success' %}
                    <span class="status-ok" title="Ostatni backup zakończony sukcesem">✅</span>
                {% else %}
                    <span class="status-fail" title="Brak backupu lub ostatni backup zakończony błędem">❌</span>
                {% endif %}
            </td>
            <td>
                <a class="btn btn-sm btn-secondary" href="{{ url_for('device_backups', ip=d.ip) }}">Pokaż backupy</a>
            </td>
            <td>
                <a class="btn btn-sm btn-secondary" href="{{ url_for('device_logs', ip=d.ip) }}">Logi</a>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</form>

{% else %}
<p>Brak urządzeń w pliku z listą IP. Sprawdź konfigurację pliku z urządzeniami (zmienna <code>DEVICES_FILE</code>).</p>
{% endif %}

<div class="card mt-4">
    <div class="card-body">
        <h2 class="h5 card-title">Automatyczny backup (CRON / harmonogram)</h2>
        <form method="post" action="{{ url_for('update_schedule') }}">
            <div class="mb-2">
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="schedule-enabled" name="enabled"
                           {% if schedule.enabled %}checked{% endif %}>
                    <label class="form-check-label" for="schedule-enabled">
                        Włącz automatyczny backup raz dziennie
                    </label>
                </div>
            </div>

            <div class="mb-2">
                <label class="form-label form-label-sm">Godzina uruchomienia (czas lokalny kontenera/serwera):</label>
                <div class="d-flex align-items-center gap-1">
                    <input type="number" name="hour" min="0" max="23" value="{{ schedule.hour }}"
                           class="form-control form-control-sm" style="max-width: 70px;">
                    <span>:</span>
                    <input type="number" name="minute" min="0" max="59" value="{{ schedule.minute }}"
                           class="form-control form-control-sm" style="max-width: 70px;">
                </div>
            </div>

            <div class="mb-2">
                <span class="form-label form-label-sm d-block">Ostatnie wykonanie (wg zapisanej informacji):</span>
                {% if schedule.last_run_date %}
                    <span>{{ schedule.last_run_date }}</span>
                {% else %}
                    <span class="text-muted">brak</span>
                {% endif %}
            </div>

            <button type="submit" class="btn btn-primary btn-sm mt-1">Zapisz harmonogram</button>
        </form>

        <p class="mt-2 mb-0" style="font-size: 0.8rem;">
            Uwaga: aby harmonogram działał, musisz uruchamiać skrypt
            <code>cron_worker.py</code> z CRONA (np. co 5–10 minut).<br>
            Skrypt sam sprawdzi, czy to już pora na dzisiejszy backup.
        </p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var selectAll = document.getElementById('select-all');
        var rows = Array.from(document.querySelectorAll('#device-table tbody tr'));

        if (selectAll) {
            selectAll.addEventListener('change', function () {
                var checked = selectAll.checked;
                rows.forEach(function (row) {
                    var cb = row.querySelector('input[type="checkbox"][name="device_ip"]');
                    if (cb) cb.checked = checked;
                });
            });
        }
    });
</script>
{% endblock %}
